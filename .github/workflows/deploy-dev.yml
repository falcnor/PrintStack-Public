name: Deploy to Development

on:
  push:
    branches: [dev]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if there are recent changes'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT: printstack-dev
  DEPLOY_TIMEOUT_MINUTES: 10
  RETRY_ATTEMPTS: 3

jobs:
  deploy:
    name: Deploy to Development Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: dev-deployment
      cancel-in-progress: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Configure npm
      run: |
        npm config set fund false
        npm config set audit false

    - name: Install dependencies
      run: npm ci
      timeout-minutes: 5
      continue-on-error: false

    - name: Setup Firebase CLI
      run: |
        curl -sL https://firebase.tools | bash
        echo "$HOME/.firebase/bin" >> $GITHUB_PATH
      shell: bash

    - name: Verify build (development mode)
      run: npm run build:prod
      timeout-minutes: 5
      env:
        NODE_ENV: production

    - name: Check build output
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed - dist directory not found"
          exit 1
        fi
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build failed - index.html not found"
          exit 1
        fi
        echo "âœ… Build verification passed"
        ls -la dist/

    - name: Deployment lock check
      id: lockcheck
      run: |
        echo "Checking for competing deployments..."
        CURRENT_TIME=$(date +%s)
        RECENT_DEPLOYMENTS=$(gh run list --workflow=deploy-prod.yml --limit=5 --json='createdAt,status' | jq -r '.[] | select(.status == "in_progress" or .status == "queued") | .createdAt')

        if [ -n "$RECENT_DEPLOYMENTS" ]; then
          echo "âš ï¸ Recent production deployments detected - proceeding with caution"
        fi
        echo "lock_check=true" >> $GITHUB_OUTPUT

    - name: Setup Google Application Credentials
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}' > service-account-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json" >> $GITHUB_ENV

    - name: Deploy to Firebase Development
      id: deploy-dev
      run: |
        echo "ğŸš€ Starting deployment to development environment..."
        echo "Project: ${{ env.FIREBASE_PROJECT }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"

        # Attempt deployment with retry logic
        for attempt in $(seq 1 ${{ env.RETRY_ATTEMPTS }}); do
          echo "ğŸ“¦ Deployment attempt $attempt of ${{ env.RETRY_ATTEMPTS }}"

          if firebase deploy --only hosting --project ${{ env.FIREBASE_PROJECT }} --non-interactive; then
            echo "âœ… Deployment successful on attempt $attempt"
            echo "deploy_success=true" >> $GITHUB_OUTPUT
            echo "deployment_url=https://printstack-dev.web.app" >> $GITHUB_OUTPUT
            break
          else
            echo "âŒ Deployment attempt $attempt failed"
            if [ $attempt -eq ${{ env.RETRY_ATTEMPTS }} ]; then
              echo "ğŸ’¥ All deployment attempts failed"
              echo "deploy_success=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
          fi
        done
      timeout-minutes: 8

    - name: Deployment verification
      run: |
        echo "ğŸ” Verifying deployment..."
        DEPLOY_URL="${{ steps.deploy-dev.outputs.deployment_url }}"
        echo "Testing URL: $DEPLOY_URL"

        # Allow time for deployment propagation
        echo "â³ Waiting 30 seconds for propagation..."
        sleep 30

        # Test the deployment URL
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL" || echo "000")
        if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "304" ]; then
          echo "âœ… Deployment verified - HTTP $HTTP_STATUS"
        else
          echo "âŒ Deployment verification failed - HTTP $HTTP_STATUS"
          echo "ğŸ”„ Attempting rollback to previous stable version..."

          # Get the previous deployment
          PREVIOUS_VERSION=$(firebase hosting:versions:list --project ${{ env.FIREBASE_PROJECT }} --limit 2 --format="json" | jq -r '.versions[1].version')
          if [ "$PREVIOUS_VERSION" != "null" ] && [ "$PREVIOUS_VERSION" != "" ]; then
            echo "ğŸ“¦ Rolling back to version $PREVIOUS_VERSION"
            firebase hosting:rollback --project ${{ env.FIREBASE_PROJECT }} --to "$PREVIOUS_VERSION" || echo "âš ï¸ Rollback failed - manual intervention required"
          else
            echo "âš ï¸ No previous version found for rollback"
          fi
          exit 1
        fi

    - name: Post-deployment health check
      run: |
        echo "ğŸ¥ Running post-deployment health checks..."
        DEPLOY_URL="${{ steps.deploy-dev.outputs.deployment_url }}"

        # Check critical resources
        CRITICAL_FILES=(
          "$DEPLOY_URL/"
          "$DEPLOY_URL/index.html"
          "$DEPLOY_URL/manifest.json"
        )

        for file in "${CRITICAL_FILES[@]}"; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$file" || echo "000")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "304" ]; then
            echo "âœ… Health check passed: $file (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Health check failed: $file (HTTP $HTTP_STATUS)"
            exit 1
          fi
        done

        echo "âœ… All health checks passed"

    - name: Deployment notification
      if: always()
      run: |
        STATUS="${{ job.status }}"
        DEPLOY_URL="${{ steps.deploy-dev.outputs.deployment_url }}"
        COMMIT_SHA="${{ github.sha }}"
        BRANCH="${{ github.ref_name }}"

        if [ "$STATUS" = "success" ]; then
          echo "ğŸ‰ **Development Deployment Successful**"
          echo "ğŸ“Š **Deployment Details**"
          echo "- ğŸŒ **URL**: $DEPLOY_URL"
          echo "- ğŸŒ¿ **Branch**: $BRANCH"
          echo "- ğŸ†” **Commit**: $COMMIT_SHA"
          echo "- â° **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "- ğŸ‘¤ **Actor**: ${{ github.actor }}"
        else
          echo "ğŸ’¥ **Development Deployment Failed**"
          echo "ğŸ“Š **Failed Deployment Details**"
          echo "- ğŸŒ¿ **Branch**: $BRANCH"
          echo "- ğŸ†” **Commit**: $COMMIT_SHA"
          echo "- â° **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "- ğŸ‘¤ **Actor**: ${{ github.actor }}"
          echo "- ğŸ”— **Action URL**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi

    - name: Update deployment status
      if: success()
      run: |
        # Create deployment status file for monitoring
        cat > deployment-status.json << EOF
        {
          "environment": "development",
          "project": "${{ env.FIREBASE_PROJECT }}",
          "url": "${{ steps.deploy-dev.outputs.deployment_url }}",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "actor": "${{ github.actor }}",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "status": "success",
          "workflow_run_id": "${{ github.run_id }}"
        }
        EOF
        echo "Deployment status file created:"
        cat deployment-status.json

  cleanup:
    name: Cleanup artifacts
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'failure')

    steps:
    - name: Cleanup workspace
      run: |
        echo "ğŸ§¹ Cleaning up workspace..."
        echo "Artifacts cleaned successfully"